```
📍 요약
- async와 defer 둘 다 다운로드 시 페이지 렌더링을 막지 않는다는 공통점이 있어 사용자가 오래 기다리지 않고 페이지 콘텐츠를 볼 수 있게 합니다.
- 차이점은:
```
![image](https://user-images.githubusercontent.com/65887537/206433958-edefa595-84d4-4a06-9de1-6907b5f35c5e.png)

<br><br>

모던 웹브라우저의 스크립트들은 대부분 HTML보다 ‘무겁습니다’. 용량이 커서 다운로드나 처리가 오래 걸리죠. 

브라우저는 HTML을 읽다가 `<script>` 태그를 만나면 스크립트를 먼저 (다운받고) 실행해야 하므로 DOM 생성을 멈춥니다. 이는 두 가지 중요한 이슈를 만듭니다.

1. 스크립트에서 스크립트 아래에 있는 DOM 요소에 접근할 수 없습니다. (DOM 요소에 핸들러 추가 등 여러 행위가 불가능해짐)
2. 페이지 위쪽에 용량이 큰 스크립트가 있는 경우 스크립트가 페이지를 ‘막아버립니다’. 사용자들은 스크립트를 다운받고 실행할 때까지 스크립트 아래쪽 페이지를 볼 수 없게 됩니다.

이런 부작용들을 피할 몇 가지 방법이 있습니다. **스크립트를 페이지 맨 아래 놓는 것**이 하나의 방법이 될 수 있으나, 완벽한 해결책이 아닙니다. HTML 문서 자체가 아주 큰 경우, 브라우저가 HTML 문서 전체를 다운받은 다음에 스크립트를 다운받으면 페이지가 정말 느려질 겁니다. 네트워크 속도가 빠른 곳이라면 지연이 눈에 잘 띄지 않지만, 아직도 네트워크가 열악한 곳이 많습니다.

다행히도 `<script>` 속성, `defer`와 `async`로 이를 해결할 수 있습니다.

<br>

# defer

브라우저는 `defer`(지연) 스크립트를 '백그라운드’에서 다운로드 합니다. 스크립트를 다운로드 하는 도중에도 HTML 파싱이 멈추지 않아 페이지 생성을 절대 막지 않습니다. 

그리고 스크립트 **실행은 페이지 구성이 끝날 때까지 지연**됩니다.  
DOM이 준비된 후, 그러나 `DOMContentLoaded` 이벤트 전에 실행됩니다.

### 💡 defer 스크립트 실행 순서

일반 스크립트와 마찬가지로 HTML에 **추가된 순(상대순, 요소순)으로 실행**됩니다.  
브라우저는 성능을 위해 페이지에 어떤 스크립트들이 있는지 쭉 **살펴본 후에야 스크립트를 병렬적으로 다운로드**합니다.  
이 때 크기가 작은 스크립트가 큰 스크립트보다 먼저 다운로드 되어도, 추가된 순으로 실행하기 때문에 큰 스크립트 다음에 실행됩니다.

### 💡 defer 속성은 외부 스크립트에만 유효합니다.

`<script>`에 `src`가 없으면 `defer` 속성은 무시됩니다.

<br>

# async

`async`(비동기) 스크립트는 페이지와 완전히 독립적으로 동작합니다.

- `defer` 스크립트와 마찬가지로 백그라운드에서 다운로드됩니다. HTML 페이지는 이를 기다리지 않고 페이지 내 콘텐츠를 처리/출력합니다. (하지만 `async` 스크립트 실행중에는 HTML 파싱이 멈춥니다)
- `DOMContentLoaded` 이벤트와 `async` 스크립트는 서로를 기다리지 않습니다. `DOMContentLoaded`가 `async` 스크립트 실행 전이나 후에 실행될 수 있습니다.
- 다른 스크립트들(**다른 `async` 스크립트 포함**)은 `async` 스크립트를 기다리지 않고, `async` 스크립트 역시 다른 스크립트들을 기다리지 않습니다.

따라서 페이지에 `async` 스크립트가 여러 개인 경우, 그 실행 순서가 제각각입니다. 다운로드가 끝난 스크립트 순으로 실행되며, 더 아래 위치해도 크기가 작은 스크립트가 먼저 실행될 수 있습니다. 이를 'load-first order’라 합니다.

방문자 수 카운터나 광고 관련 스크립트처럼 각각 독립적인 역할을 하는 서드 파티 스크립트(ex. Google Analytics)를 현재 개발 중인 스크립트에 통합하려 할 때 아주 유용합니다. `async` 스크립트와 개발 중인 스크립트가 서로 의존하지 않기 때문입니다.

<br>

# 동적 스크립트

자바스크립트로 문서에 스크립트를 동적으로 추가할 수 있습니다. 이를 동적 스크립트(dynamic script)라고 부릅니다.

```js
let script = document.createElement('script');
script.src = "/article/script-async-defer/long.js";
document.body.append(script);
```

외부 스크립트는 문서에 추가(`append`)되자 마자 다운로드가 시작됩니다.

그런데 **동적 스크립트는 기본적으로 `async` 스크립트처럼** 행동합니다.

- 동적 스크립트는 그 어떤 것도 기다리지 않고, 그 어떤 것도 동적 스크립트를 기다리지 않습니다.
- 먼저 다운로드된 스크립트가 먼저 실행됩니다(‘load-first’ order).

문서에 추가된 순서대로 실행하려면 `script.async=false`를 추가합니다.
