# 프라미스 체이닝

프라미스 체이닝은 아래와 같이 생겼습니다.

```js
new Promise(function(resolve, reject) {
  ..  
}).then(function(result) {
  ..
}).then(function(result) {
  ..
```

아래와 같은 순서로 실행됩니다.

1. 최초 프라미스가 이행됩니다.
2. 이후 첫번째 `.then` 핸들러가 호출됩니다.
3. 2에서 반환한 값은 다음 `.then` 핸들러에 전달됩니다.
4. 이런 과정이 계속 이어집니다.

프라미스 체이닝이 가능한 이유는 **`promise.then`을 호출하면 프라미스가 반환되기 때문**입니다. 

한편 핸들러가 값을 반환할 때엔 이 값이 프라미스의 `result`가 됩니다. 따라서 다음 `.then`은 이 값을 이용해 호출됩니다.

<br>

**프라미스 하나에 .then을 여러 개 추가한 것은 체이닝이 아닙니다.** 
한 프라미스에 여러 핸들러가 등록됐다면, 이 핸들러들은 `result`를 순차적으로 전달하지 않고 독립적으로 처리합니다.

```js
let promise = new Promise(..);

promise.then(function(result) {..});
promise.then(function(result) {..});
```

<br><br>

## 프라미스 반환하기

`.then(handler)`에 사용된 핸들러가 프라미스를 생성하거나 반환하는 경우도 있습니다.
이 경우 이어지는 핸들러는 프라미스가 처리될 때까지 기다리다가 처리가 완료되면 그 결과를 받습니다.

```js
new Promise(function(resolve, reject) {
  //..
}).then(function(result) {
  return new Promise((resolve, reject) => { .. });  // 이 프라미스가 이행된 결과가
}).then(function(result) {                          // 여기로 전달됩니다
  ..
```

<br><br>

## loadScript 예시 개선하기

이전 챕터에서 프라미스를 사용해 정의한 `loadScript`를 개선해봅시다.

```js
loadScript("url")
  .then(function(script) {
    return loadScript("url2"); 
  })
  .then(function(script) {
    return loadScript("url3");
  })
  .then(function(script) {
    // 불러온 스크립트 안에 정의된 함수를 호출해 실제로 스크립트들이 정상적으로 로드되었는지 확인합니다.
    one();
    two();
    three();
  });
```

`loadScript`를 호출할 때마다 프라미스가 반되고, 프라미스가 이행된 후 `.then`이 실행됩니다.
이후에 다음 스크립트를 로딩하기 위한 초기화가 진행됩니다. 스크립트는 이런 과정을 거쳐 순차적으로 로드됩니다.

화살표 함수로 코드를 줄일 수도 있습니다:

```js
loadScript("url")
  .then(script => loadScript("url2"))
  .then(script => loadScript("url3"))
  .then(script => {
    one();
    two();
    three();
  });
```

`loadScript`에 `.then`을 바로 붙일 수도 있습니다.
하지만 콜백과 동일하게 코드가 '오른쪽으로' 길어지는 문제가 생깁니다.
따라서 **대게 체이닝이 선호**됩니다.

단, 중첩 함수에서 외부 스코프에 접근할 수 있기 때문에 `.then`을 바로 쓰는 게 괜찮은 예외 상황도 있습니다. 
아래 예제에서 가장 깊은 곳에 있는 중첩 콜백은 script1, script2, script3 안에 있는 변수 모두에 접근할 수 있습니다. 

```js
loadScript("url").then(script1 => {
  loadScript("url2").then(script2 => {
    loadScript("url3").then(script3 => {
      one();
      two();
      three();
    });
  });
});
```

<br>

### 💡 thenable

