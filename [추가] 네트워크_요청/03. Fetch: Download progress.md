```
ğŸ“ ìš”ì•½
```

<br>

`fetch`ë¡œ ë‹¤ìš´ë¡œë“œ ì§„ë„ë¥¼ ì¶”ì í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (í˜„ì¬ `fetch`ë¡œ **ì—…ë¡œë“œ ì§„ë„ë¥¼ ì¶”ì í•˜ëŠ” ë°©ë²•ì€ ì—†ìŠµë‹ˆë‹¤**. `XMLHttpRequest`ë¥¼ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤)

ì¶”ì ì„ ìœ„í•´ ì‚¬ìš©í•  `response.body` í”„ë¡œí¼í‹°ëŠ” íŠ¹ë³„í•œ ê°ì²´ì¸ [`ReadableStream` ê°ì²´](https://streams.spec.whatwg.org/#rs-class)ë¡œ, bodyê°€ ë„ì°©í•˜ëŠ” ëŒ€ë¡œ ë¶€ë¶„ì”©(chunk-by-chunk) ì œê³µí•©ë‹ˆë‹¤. `text()` `json()` ë“± ë‹¤ë¥¸ ë©”ì„œë“œì™€ ë‹¬ë¦¬ ì§„í–‰ ìƒí™©ì— ëŒ€í•œ ì™„ì „í•œ í†µì œê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.

```js
const reader = response.body.getReader();

while(true) {
  const {done, value} = await reader.read();
  if (done) break;
}
```

**`await reader.read()`ì˜ ë°˜í™˜ê°’ì€ ë‹¤ìŒ ë‘ í”„ë¡œí¼í‹°ë¥¼ ê°€ì§„ ê°ì²´**ì…ë‹ˆë‹¤:

- `done` â€“ ë§ˆì§€ë§‰ chunkì¼ ê²½ìš°(ì½ê¸°ê°€ ì™„ë£Œëœ ê²½ìš°) `true`, ì•„ë‹ˆë©´ `false`
- `value` â€“ chunk ë°”ì´íŠ¸ì˜ typed array `Uint8Array`

ì´ì œ ì§„í–‰ ìƒí™©ì„ ì¶”ì í•˜ë ¤ë©´, ë°›ì€ valueì˜ ê¸¸ì´ë§Œí¼ ëˆ„ì í•˜ë©´ ë©ë‹ˆë‹¤.

ì½˜ì†”ì— ì§„í–‰ìƒí™©ì„ ì¶œë ¥í•˜ëŠ” ì „ì²´ ì½”ë“œ:

```js
// 1ë‹¨ê³„
let response = await fetch(url);

const reader = response.body.getReader();

// 2ë‹¨ê³„: ë°ì´í„°ì˜ ì „ì²´ ê¸¸ì´ êµ¬í•˜ê¸°
const contentLength = +response.headers.get('Content-Length');

// 3ë‹¨ê³„: ë°ì´í„° ì½ì–´ì˜¤ê¸°
let receivedLength = 0; // í˜„ì¬ê¹Œì§€ ë°›ì€ ë°”ì´íŠ¸ ê°œìˆ˜
let chunks = []; // ë°›ì€ binary chunkì„ ì €ì¥í•´ë‘˜ ë°°ì—´ (comprises the body)
while(true) {
  const {done, value} = await reader.read();

  if (done) break;

  chunks.push(value);
  receivedLength += value.length;

  console.log(`Received ${receivedLength} of ${contentLength}`)
}

// 4ë‹¨ê³„: chunkë“¤ì„ í•˜ë‚˜ì˜ Uint8Arrayë¡œ í•©ì¹¨
let chunksAll = new Uint8Array(receivedLength);
let position = 0;
for(let chunk of chunks) {
  chunksAll.set(chunk, position);
  position += chunk.length;
}

// 5ë‹¨ê³„: ë¬¸ìì—´ë¡œ decode
let result = new TextDecoder("utf-8").decode(chunksAll);

// ë!
let commits = JSON.parse(result);
alert(commits[0].author.login);
```

1. `response.json()` ëŒ€ì‹  `response.body.getReader()`ë¡œ stream readerë¥¼ ë°›ì•„ì˜µë‹ˆë‹¤.   

   ê°™ì€ responseì— ë©”ì„œë“œë¥¼ ì—¬ëŸ¬ê°œ ì‚¬ìš©í•  ìˆ˜ ì—†ìŒì— ì£¼ì˜í•©ì‹œë‹¤.
2. ë¯¸ë¦¬ ì „ì²´ responseì˜ ê¸¸ì´ë¥¼ `Content-Length` í—¤ë”ë¡œ ë°›ì•„ì˜µë‹ˆë‹¤.   

   cross-origin-requestë¼ë©´ í—¤ë”ê°’ì´ ì—†ì„ ìˆ˜ ìˆìœ¼ë©°, ì„œë²„ì—ì„œ ê¼­ ì„¤ì •í•´ì•¼í•˜ëŠ” í—¤ë”ëŠ” ì•„ë‹ˆì§€ë§Œ, ë³´í†µ ì¡´ì¬í•©ë‹ˆë‹¤.
3. `chunks` ë°°ì—´ì— response chunkë¥¼ ëª¨ì•„ë‘¡ë‹ˆë‹¤.

   í•œë²ˆ ì‚¬ìš©ëœ(consumed) responseëŠ” ë‹¤ë¥¸ ë©”ì„œë“œë¥¼ ì‚¬ìš©í•´ ë‹¤ì‹œ ëª» ì½ê¸° ë•Œë¬¸ì— ì €ì¥í•´ë‘ì–´ì•¼ í•©ë‹ˆë‹¤.
4. ì´ì œ `chunks`ë¥¼ í•˜ë‚˜ë¡œ í•©ì¹©ë‹ˆë‹¤. ì•„ì§ ì´ë¥¼ ìœ„í•œ ë©”ì„œë“œëŠ” ì—†ê¸° ë•Œë¬¸ì—:

   1. ë™ì¼í•œ íƒ€ì…ì˜ ë°°ì—´ `chunksAll`ì„ ì´ê¸¸ì´ë§Œí¼ í• ë‹¹í•©ë‹ˆë‹¤.
   2. `.set(chunk, position)`ìœ¼ë¡œ ê° chunkë¥¼ ë³µì‚¬í•´ ë¶™ì…ë‹ˆë‹¤.
5. ì•„ì§ `chunksAll`ì€ ë°”ì´íŠ¸ ë°°ì—´ì´ì§€ ë¬¸ìì—´ì´ ì•„ë‹™ë‹ˆë‹¤.

   1. ë¬¸ìì—´ì„ ë§Œë“¤ê¸° ìœ„í•´ ë°”ì´íŠ¸ë¥¼ í•´ì„í•´ì•¼ í•˜ëŠ”ë°, ë‚´ì¥ [TextDecoder](https://ko.javascript.info/text-decoder)ê°€ ì´ë¥¼ í•´ì¤ë‹ˆë‹¤. ì´í›„, í•„ìš”í•˜ë‹¤ë©´ `JSON.parse`í•©ë‹ˆë‹¤.
   2. ë°”ì´ë„ˆë¦¬ ì»¨í…ì¸ ê°€ í•„ìš”í•˜ë‹¤ë©´ ë” ê°„ë‹¨í•©ë‹ˆë‹¤. 4&5 ë‹¨ê³„ë¥¼ ë‹¤ìŒ ì¤„ë¡œ ëŒ€ì‹ í•©ë‹ˆë‹¤.

   ```js
   let blob = new Blob(chunks);
   ```

<br>

### ğŸ’¡ for await..of loop

Streams APIëŠ” `for await..of` ë¬¸ë²•ìœ¼ë¡œ `ReadableStream`ì— ëŒ€í•œ ë¹„ë™ê¸°ì  ìˆœíšŒë„ ì œê³µí•˜ì§€ë§Œ, ë§ì€ ë¸Œë¼ìš°ì €ì—ì„œ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

<br><br><br>

ì¶œì²˜: https://ko.javascript.info/fetch-progress
