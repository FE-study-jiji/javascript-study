```
ğŸ“ ìš”ì•½
```
<br>

ë‚´ì¥ í´ë˜ìŠ¤ `EventSource`ëŠ” ì„œë²„ì™€ ì»¤ë„¥ì…˜ì„ ìœ ì§€í•˜ê³  ì„œë²„ì—ì„œë¶€í„° ì´ë²¤íŠ¸ë¥¼ ë°›ì„ ìˆ˜ ìˆë„ë¡ í•´ì¤ë‹ˆë‹¤. ì„œë²„ë¡œë¶€í„° ë°ì´í„° ìŠ¤íŠ¸ë¦¼ì„ ë°›ì„ ë•Œ(ì±„íŒ… ë©”ì‹œì§€, ì‹œê°€ ë“±) ì¢‹ìŠµë‹ˆë‹¤.

ì»¤ë„¥ì…˜ì„ ìœ ì§€(persistent)í•œë‹¤ëŠ” ì ì€ `WebSocket`ê³¼ ë¹„ìŠ·í•˜ì§€ë§Œ í° ì°¨ì´ì ì´ ìˆìŠµë‹ˆë‹¤:

![image](https://user-images.githubusercontent.com/65887537/210701011-44768af1-c903-4b52-8e2b-49548f07e77e.png)

`WebSocket`ë³´ë‹¤ ì•½í•œ ì„œë²„ ì—°ê²° ë°©ì‹ì¸ë°, ì‹¤ì œë¡  ë§ì€ ì–´í”Œë¦¬ì¼€ì´ì…˜ì—ì„  `WebSocket`ì€ ê³¼í•œ ë¶€ë¶„ì´ ìˆê¸° ë•Œë¬¸ì—, ê°„ë‹¨í•œ `EventSource`ë„ ì¢‹ì€ ì„ íƒì§€ì…ë‹ˆë‹¤. ë˜í•œ ë¹„êµì  low-levelì¸ `WebSocket`ì´ ì§€ì›í•˜ì§€ ì•ŠëŠ”(êµ¬í˜„ì€ ê°€ëŠ¥í•¨) **ìë™ ì¬ì—°ê²°**(`retry` íƒ€ì„ì•„ì›ƒ), ì¬ì—°ê²°ì„ ìœ„í•œ ë©”ì‹œì§€ ID, `readyState` ë“±ì„ ì§€ì›í•˜ë©°, ìƒˆë¡œìš´ í”„ë¡œí† ì½œì´ ì•„ë‹Œ HTTPì„ ì‚¬ìš©í•œë‹¤ëŠ” íŠ¹ì§•ì´ ìˆìŠµë‹ˆë‹¤. ëª¨ë“  ëª¨ë˜ ë¸Œë¼ìš°ì €(IE ì œì™¸)ì—ì„œ ì§€ì›ë©ë‹ˆë‹¤.

<br><br>

# Getting messages

ë©”ì‹œì§€ë¥¼ ë°›ê¸° ì‹œì‘í•˜ë ¤ë©´ `EventSource`ë¥¼ ìƒì„±í•©ë‹ˆë‹¤. ë¸Œë¼ìš°ì €ê°€ `url`ì— ì—°ê²°í•˜ê³  ì´ë²¤íŠ¸ë¥¼ ê¸°ë‹¤ë¦¬ë©° ì»¤ë„¥ì…˜ì„ ì—´ì–´ë‘¡ë‹ˆë‹¤. 

```js
let eventSource = new EventSource(url, [credentials]);
```

ì„œë²„ëŠ” status `200`ê³¼ í—¤ë” `Content-Type: text/event-stream`ë¡œ ì‘ë‹µí•˜ê³ , ì»¤ë„¥ì…˜ì„ ìœ ì§€í•˜ë©° **íŠ¹ë³„í•œ í¬ë§·ì˜ ë©”ì‹œì§€ë¥¼** ì „ì†¡í•©ë‹ˆë‹¤.

```
data: Message 1

data: Message 2

data: Message 3
data: of two lines
```

- ë©”ì‹œì§€ í…ìŠ¤íŠ¸ëŠ” `data:` ë’¤ì— ì ìŒ
- ë©”ì‹œì§€ëŠ” `\n\n`ë¡œ êµ¬ë¶„ë¨
- ì¤„ë°”ê¿ˆ`\n`ì„ í•˜ë ¤ë©´ ë°”ë¡œ `data:`ë¥¼ í•˜ë‚˜ ë” ë³´ëƒ„
 
ì‹¤ì œì—ì„  ë³µì¡í•œ ë©”ì‹œì§€ëŠ” ë©€í‹°ë¼ì¸ìœ¼ë¡œ ë³´ë‚´ê¸°ë³´ë‹¤ JSON-encodedë˜ì–´ ë³´ëƒ…ë‹ˆë‹¤. ë”°ë¼ì„œ `data:`ê°€ ë”± í•˜ë‚˜ì˜ ë©”ì‹œì§€ë§Œ ê°€ì§„ë‹¤ê³  ê°„ì£¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```js
data: {"user":"John","message":"First line\n Second line"}
```

**ê° ë©”ì‹œì§€ë§ˆë‹¤ `message` ì´ë²¤íŠ¸ê°€ ë°œìƒ**í•©ë‹ˆë‹¤.

```js
eventSource.onmessage = function(event) {
  console.log("New message", event.data); // will log 3 times for the data stream above
};
```

<br>

### Cross-origin-requests

`EventSource`ëŠ” í¬ë¡œìŠ¤ì˜¤ë¦¬ì§„ ìš”ì²­ì„ ì§€ì›í•©ë‹ˆë‹¤. 

ì„œë²„ëŠ” `Origin` í—¤ë”ë¥¼ ë°›ê³ , ê³„ì†í•˜ê¸° ìœ„í•´ì„  `Access-Control-Allow-Origin`ì™€ í•¨ê»˜ ì‘ë‹µí•´ì•¼ í•©ë‹ˆë‹¤. 

ì¸ì¦ ì •ë³´(credentials)ì„ ë³´ë‚´ë ¤ë©´ `withCredentials`ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤. (ì „ë°˜ì ì¸ í¬ë¡œìŠ¤ì˜¤ë¦¬ì§„ ë³´ì•ˆì€ fetch ë“±ê³¼ ë¹„ìŠ·í•¨. CORS ì±•í„° ì°¸ê³ )

```js
let source = new EventSource("https://another-site.com/events", {
  withCredentials: true
});
```

<br><br>

# Reconnection

ì»¤ë„¥ì…˜ì´ ëŠê¸´ë‹¤ë©´ `EventSource`ëŠ” ì¬ì—°ê²°í•©ë‹ˆë‹¤. ì—°ê²° ì‚¬ì´ì— ê¸°ë³¸ì ìœ¼ë¡œ ëª‡ ì´ˆì˜ ë”œë ˆì´ë¥¼ ë‘¡ë‹ˆë‹¤. ì„œë²„ëŠ” ì¶”ì²œí•˜ëŠ” ë”œë ˆì´(in milliseconds)ë¥¼ ì‘ë‹µì˜ `retry:`ë¥¼ í†µí•´ ì§€ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì €ëŠ” í•´ë‹¹ ì‹œê°„ë§Œí¼, í˜¹ì€ ë” ê¸¸ê²Œ(ex. ë¸Œë¼ìš°ì €ê°€ OSë¡œë¶€í„° ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì´ ì—†ë‹¤ëŠ” ê±¸ ì „ë‹¬ë°›ëŠ”ë‹¤ë©´) ê¸°ë‹¤ë ¸ë‹¤ ì¬ì‹œë„í•©ë‹ˆë‹¤.

```
retry: 15000
data: Hello, I set the reconnection delay to 15 seconds // ì˜µì…”ë„
```

ì„œë²„ê°€ ì¬ì—°ê²°ì„ ì›í•˜ì§€ ì•ŠëŠ”ë‹¤ë©´ HTTP status `204`ë¡œ ì‘ë‹µí•©ë‹ˆë‹¤.

ë¸Œë¼ìš°ì €ê°€ ì»¤ë„¥ì…˜ì„ ë‹«ê³  ì‹¶ë‹¤ë©´ `close()`ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤. 

```js
let eventSource = new EventSource(...);
eventSource.close();
```

ë˜í•œ, ì‘ë‹µì˜ `Content-Type`ì´ ì˜ëª»ë˜ì—ˆê±°ë‚˜ HTTP statusê°€ `301` `307` `200` `204`ê°€ ì•„ë‹ˆë¼ë©´, `"error"` ì´ë²¤íŠ¸ê°€ ë°œìƒí•˜ê³  ë¸Œë¼ìš°ì €ëŠ” ì¬ì—°ê²°í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

### ğŸ’¡ í•œë²ˆ ì»¤ë„¥ì…˜ì´ ë‹«íˆë©´ ë‹¤ì‹œ ì˜¤í”ˆí•˜ëŠ” ë°©ë²•ì€ ì—†ìŠµë‹ˆë‹¤. 

ë‹¤ì‹œ ì—°ê²°í•˜ê³  ì‹¶ë‹¤ë©´ ìƒˆë¡œ `EventSource`ë¥¼ ìƒì„±í•´ì•¼ í•©ë‹ˆë‹¤.

<br><br>

# Message ID

ì»¤ë„¥ì…˜ì´ ë„¤íŠ¸ì›Œí¬ ë¬¸ì œë¡œ ëŠê¸°ë©´, ì–‘ì¸¡ì—ì„  ì–´ë–¤ ë©”ì‹œì§€ê°€ ì „ì†¡ë˜ì—ˆëŠ”ì§€(received) ì•Œ ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤. ì»¤ë„¥ì…˜ì„ ì•Œë§ê²Œ ì¬ê°œí•˜ë ¤ë©´ **ê° ë©”ì‹œì§€ê°€ `id` í•„ë“œë¥¼ ê°€ì ¸ì•¼ í•©ë‹ˆë‹¤**. 

```
data: Message 1
id: 1

data: Message 2
data: of two lines
id:2
```

`id:`ë¥¼ ê°€ì§„ ë©”ì‹œì§€ë¥¼ ë°›ì€ ë¸Œë¼ìš°ì €ëŠ”

- `eventSource.lastEventId` ê°’ì„ í•´ë‹¹ idë¡œ ì„¤ì •í•¨
- ì¬ì—°ê²°ì‹œ í—¤ë”ì˜ `Last-Event-ID`ì— í•´ë‹¹ `id`ë¥¼ ë³´ë‚´ì–´ ì„œë²„ê°€ ì´í›„ ë©”ì‹œì§€ë¥¼ ë‹¤ì‹œ ì „ì†¡í•  ìˆ˜ ìˆë„ë¡ í•¨

`lastEventId`ê°€ ë©”ì‹œì§€ë¥¼ ë°›ì€ 'í›„ì—' ì—…ë°ì´íŠ¸ë  ìˆ˜ ìˆë„ë¡ `id:`ë¥¼ `data:` ë‹¤ìŒì— ì ìŠµë‹ˆë‹¤.

<br><br>

# Connection status: readyState

`EventSource`ì˜ ìƒí™©ì„ ì•Œë ¤ì£¼ëŠ” `readyState` í”„ë¡œí¼í‹°ëŠ” ë‹¤ìŒ ì…‹ ì¤‘ í•˜ë‚˜ì˜ ê°’ì„ ê°€ì§‘ë‹ˆë‹¤. 

```js
EventSource.CONNECTING == 0; // connecting or reconnecting - ê°ì²´ê°€ ìƒì„±ë˜ì—ˆê±°ë‚˜ ì»¤ë„¥ì…˜ì´ ëŠê¸´ ìƒí™©ì—” ì–¸ì œë‚˜ 0
EventSource.OPEN == 1;       // connected
EventSource.CLOSED == 2;     // connection closed
```

<br><br>

# Event types

`EventSource`ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ì„¸ê°€ì§€ ì´ë²¤íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.

- `message` â€“ a message received, available as event.data.
- `open` â€“ the connection is open.
- `error` â€“ the connection could not be established, e.g. the server returned HTTP 500 status.

ì„œë²„ëŠ” ì´ ì™¸ ì»¤ìŠ¤í…€ ì´ë²¤íŠ¸ë¥¼ ëª…ì‹œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë²¤íŠ¸ ì‹œì‘ì— `event: ...`ë¥¼ ì‘ì„±í•˜ë©´ ë©ë‹ˆë‹¤.

```
event: join
data: Bob

data: Hello

event: leave
data: Bob
```

ì»¤ìŠ¤í…€ ì´ë²¤íŠ¸ë¥¼ ì²˜ë¦¬í•˜ë ¤ë©´ `addEventListener`ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.

<br><br><br>

ì¶œì²˜: https://ko.javascript.info/server-sent-events
